from __future__ import division

import pefile
import os
from collections import defaultdict 
import datetime
import json
import sys
import re
import peutils
from future import standard_library
standard_library.install_aliases()
from builtins import range
from builtins import object
import string
import urllib.request, urllib.parse, urllib.error


#set begin time to find out the time taken by the script to run
begin_time = datetime.datetime.now()
IMPORT_DICTIONARY = defaultdict(list) # key - PE file name/path and value - list of import API calls
#JSON_PATH = sys.argv[1] # path that contains the osquery result file
queryList=[]
List_path = set() # set of the all folders that are present in the system


def listimports(fname):

    I = []
    mype2=pefile.PE(fname,fast_load=True)
    if mype2.OPTIONAL_HEADER.DATA_DIRECTORY[pefile.DIRECTORY_ENTRY['IMAGE_DIRECTORY_ENTRY_IMPORT']].VirtualAddress != 0:
        mype2.parse_data_directories(directories=[pefile.DIRECTORY_ENTRY['IMAGE_DIRECTORY_ENTRY_IMPORT']])
        if mype2.DIRECTORY_ENTRY_IMPORT is not None:
            for entry in mype2.DIRECTORY_ENTRY_IMPORT:
                for imptab in entry.imports:
                    if imptab.name is None:
                        imptab.name = "None"
                    if imptab.address is None :
                        imptab.address = int(0) 
                    x = imptab.name
                    I.append(x)
    return I;

PATH = "C:\Benign"

#replace 'PATH' by the elements of List_path and loop the following for loop for each element(i.e folder name) to get import API calls of all the PE files in that particular folder

sig_db = peutils.SignatureDatabase()

for root, subdirectories, files in os.walk(PATH):
	for subdirectory in subdirectories:
	        print(os.path.join(root, subdirectory))
	for file in files:
		current_file = os.path.join(root, file)
		try :
			print(current_file)
			IMPORT_DICTIONARY[current_file].append(listimports(current_file));
			print("-----\n");
			#pe = pefile.PE(current_file)
			#try:
			#	for entry in pe.DIRECTORY_ENTRY_IMPORT:
			#		if(API in entry.imports) :
			#			for API in entry.imports:
			#				IMPORT_DICTIONARY[current_file].append(API.name)
			#except:
			#	print('some error')
		except:
			pass
#key is the PE file name/path
#value is the list of API calls
f = open('benign_API', 'w')


for key in IMPORT_DICTIONARY:
	print(IMPORT_DICTIONARY[key], file=f)
	#print( '\n', file=f )

print(datetime.datetime.now() - begin_time)



